<!DOCTYPE html>
<html>
  <head>
    <title>MQTT messages</title>
  </head>
  <body>

    <h1>MQTT messages</h1>
    <br />
    <br />

    <div id="main" style="border: 1px solid #ccc; margin 20px; padding: 20px; height: 100px; overflow: auto;">Loading...<br /></div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <figure class="highcharts-figure">
        <div id="container-speed" class="chart-container"></div>
    </figure>


   <script type="text/javascript">
      const gaugeOptions = {
          chart: {
              type: 'solidgauge'
          },

          title: null,

          pane: {
              center: ['50%', '85%'],
              size: '140%',
              startAngle: -90,
              endAngle: 90,
              background: {
                  backgroundColor:
                      Highcharts.defaultOptions.legend.backgroundColor || '#EEE',
                  innerRadius: '60%',
                  outerRadius: '100%',
                  shape: 'arc'
              }
          },

          exporting: {
              enabled: false
          },

          tooltip: {
              enabled: false
          },

          // the value axis
          yAxis: {
              stops: [
                  [0.1, '#55BF3B'], // green
                  [0.5, '#DDDF0D'], // yellow
                  [0.9, '#DF5353'] // red
              ],
              lineWidth: 0,
              tickWidth: 0,
              minorTickInterval: null,
              tickAmount: 2,
              title: {
                  y: -70
              },
              labels: {
                  y: 16
              }
          },

          plotOptions: {
              solidgauge: {
                  dataLabels: {
                      y: 5,
                      borderWidth: 0,
                      useHTML: true
                  }
              }
          }
      };

      // The speed gauge
      const chartSpeed = Highcharts.chart('container-speed', Highcharts.merge(gaugeOptions, {
          yAxis: {
              min: 0,
              max: 200,
              title: {
                  text: 'Temperature'
              }
          },

          credits: {
              enabled: false
          },

          series: [{
              name: 'Temp',
              data: [0],
              dataLabels: {
                  format:
                      '<div style="text-align:center">' +
                      '<span style="font-size:25px">{y}</span><br/>' +
                      '<span style="font-size:12px;opacity:0.4">Celcius</span>' +
                      '</div>'
              },
              tooltip: {
                  valueSuffix: 'Celcius'
              }
          }]

      }));
    </script>


    <script type="text/javascript">
      const consoleAdd = function (text) {
        const main = document.getElementById('main');
        main.innerHTML += text + '<br />';
        main.scrollTop = main.scrollHeight;
      }

      // Connection to your MQTT server, using websocket protocol.
      // Note: you have to activate websocket support on Stackhero console, in your service configuration.
      // This example uses the library MQTT.js (https://github.com/mqttjs/MQTT.js)

      // IMPORTANT: you should create a dedicated user with limited rights.
      // Remember that any client using this page can read the source code and get those credentials!
      // Note: on Node-RED, the websocket URL ends with "/mqtt/"
      const url = 'ws://jetson:9001/mqtt';
      const username = 'admin';
      const password = 'admin';

      consoleAdd('Connecting to MQTT server ' + url + '...');

      // Connecting to MQTT server using websockets
      const client = mqtt.connect(url, { username, password });

      client.on('error', function (error) {
        consoleAdd('Error: ' + error);
      });

      client.on('close', function () {
        consoleAdd('Connection has been closed');
      });

      client.on('reconnect', function () {
        consoleAdd('Reconnecting...');
      });

      // On MQTT connection, we subscribe to the "presence" topic and send "Hello MQTT" to it.
      client.on('connect', function () {
        consoleAdd('Connected!');
        const topic = 'i10';
        client.subscribe(topic, function (err, res) {
          if (err) {
            consoleAdd('Error when subscribing to topic ' + topic + ': ' + err);
            return;
          }
       })
      });

      // Show messages received on every topic
      client.on('message', function (topic, message) {
        consoleAdd('Message received from MQTT server on topic "' + topic + '": ' + message);
        const obj = JSON.parse(message);
        let point,
              newVal,
              inc;

        if (chartSpeed) {
              point = chartSpeed.series[0].points[0];
              //inc = Math.round((Math.random() - 0.5) * 100);
              //newVal = obj.temp + inc;

              //if (newVal < 0 || newVal > 200) {
              //      newVal = point.y - inc;
              //}

              point.update(obj.temp);
        }

        
      });
    </script>
  </body>
</html>
